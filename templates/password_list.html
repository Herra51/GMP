{% extends 'base.html' %}
{% block title %}Password List{% endblock %}

{% block content %}
<div>

    <button name="add_password">Ajouter une entrée</button>
    <button name="confirm_add" style="display: none;">Valider</button>
    <select id="category-filter">
        <option value="">Toutes</option>
        {% for categorie in categories %}
            <option value="{{ categorie.id_password_category }}">{{ categorie.category_name }}</option>
        {% endfor %}
    </select>
    <div class="overlay" id="overlay">
        <div class="password-panel" id="password-panel">
            <h3>Password Generator</h3>
            <label for="length">Length:</label>
            <input type="number" id="length" min="4" max="32" value="12"><br><br>
    
            <label>
                <input type="checkbox" id="include-uppercase" checked>
                Include Uppercase
            </label><br>
            <label>
                <input type="checkbox" id="include-numbers" checked>
                Include Numbers
            </label><br>
            <label>
                <input type="checkbox" id="include-symbols" checked>
                Include Symbols
            </label><br><br>
            <label for="exclude-characters">Exclude Characters:
            <input type="text" id="exclude-characters" placeholder="e.g., abc123">
            </label><br><br>
            <button class="btn" id="generate-btn">Generate</button>
            <button class="btn" id="close-panel-btn" style="background-color: #dc3545;">Close</button>
    
            <p><strong>Generated Password:</strong></p>
            <p id="generated-password" style="word-break: break-word;"></p>
        </div>
    </div>
    <div id="table-container">
        <table>
                        <thead>
                <tr>
                    <th>Catégorie</th>
                    <th>Platforme</th>
                    <th>Login</th> <!-- Nouveau champ -->
                    <th>URL</th> <!-- Nouveau champ -->
                    <th>Passwords</th>
                    <th>Date création</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for password in passwords %}
                <tr>
                    <td>{{ password.category_name }}</td>
                    <td>{{ password.platform_name }}</td>
                    <td>{{ password.login }}</td> <!-- Nouveau champ -->
                    <td><a href="{{ password.url }}" target="_blank">{{ password.url }}</a></td> <!-- Nouveau champ -->
                    <td>
                        <input type="password" value="{{ password.password }}" class="password-field" readonly>
                        <button type="button" class="toggle-password">Afficher</button>
                        <button type="button" class="copy-password" data-password="{{ password.password }}">Copier</button>
                    </td>
                    <td>{{ password.created_at }}</td>
                    <td>
                        <button class="share-btn" data-id="{{ password.id_password }}">Partager</button>
                        <button class="edit-btn" data-id="{{ password.id_password }}">Modifier</button>
                        <button class="delete-btn" data-id="{{ password.id_password }}">Supprimer</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{%block scripts%}
<script>
    // Copy password to clipboard
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.copy-password').forEach(button => {
            button.addEventListener('click', () => {
                const password = button.getAttribute('data-password');
                navigator.clipboard.writeText(password).then(() => {
                    alert('Mot de passe copié dans le presse-papiers !');
                }).catch(err => {
                    console.error('Erreur lors de la copie : ', err);
                });
            });
        });
    });
    // Toggle password visibility
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', () => {
                const passwordField = button.previousElementSibling;
                if (passwordField.type === 'password') {
                    passwordField.type = 'text';
                    button.textContent = 'Cacher';
                } else {
                    passwordField.type = 'password';
                    button.textContent = 'Afficher';
                }
            });
        });
    });
    // Filter passwords by category
    const categoryFilter = document.getElementById('category-filter');
    categoryFilter.addEventListener('change', async () => {
        const selectedCategory = categoryFilter.value;
        const response = await fetch('/filter_passwords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ category: selectedCategory })
        });
        const data = await response.json();
        const tableBody = document.querySelector('table tbody');
        tableBody.innerHTML = ''; // Clear existing rows
        data.passwords.forEach(password => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${password.category_name}</td>
                <td>${password.platform_name}</td>
                <td>${password.password}</td>
                <td>${password.created_at}</td>
                <td>
                    <button class="share-btn" data-id="${password.id_password}">Partager</button>
                    <button class="edit-btn" data-id="${password.id_password}">Modifier</button>
                    <button class="delete-btn" data-id="${password.id_password}">Supprimer</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    });

    // Add password => ajoute les inputs et actives le bouton de validation
    const button = document.querySelector('button[name="add_password"]');

    button.addEventListener('click', async () => {
        const tableContainer = document.querySelector('table tbody');
        const overlay = document.getElementById('overlay');

        const existingInputRow = tableContainer.querySelector('tr input#platform_name');
        if (!existingInputRow) {
            const newRow = document.createElement('tr');
            const currentDate = new Date().toISOString().split('T')[0];
            
            newRow.innerHTML = `
                <td><select id="category_id">
                    <option value="0">Aucune</option>
                    {% for categorie in categories %}
                        <option value="{{ categorie.id_password_category }}">{{ categorie.category_name }}</option>
                    {% endfor %}
                </select></td>
                <td><input type="text" id="platform_name" placeholder="Nom de la plateforme"></td>
                <td><input type="text" id="login" placeholder="Identifiant"></td>
                <td><input type="text" id="url" placeholder="URL"></td>
                <td>
                    <input type="text" id="password" placeholder="Mot de passe">
                    <button type="button" class="open-generator-btn">Générer</button>
                </td>
                
                <td>${currentDate}</td>
            `;

            tableContainer.prepend(newRow);
            const confirmButton = document.querySelector('button[name="confirm_add"]');
            confirmButton.style.display = 'block';
            const button_add_password = document.querySelector('button[name="confirm_add"]');
            const input_add_password = document.querySelector('input[id="password"]');
            button_add_password.addEventListener('click', addPassword);
            input_add_password.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    addPassword();
                }
            });
            const open_generator = document.querySelector('button[class="open-generator-btn"]');
            const passwordPanel = document.getElementById('password-panel');
            const overlay = document.getElementById('overlay');

            open_generator.addEventListener('click', () => {
                const overlay = document.getElementById('overlay');
                const passwordPanel = document.getElementById('password-panel');
                overlay.classList.add('active');
                passwordPanel.classList.add('active');
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    const overlay = document.getElementById('overlay');
                    const passwordPanel = document.getElementById('password-panel');
                    overlay.classList.remove('active');
                    passwordPanel.classList.remove('active');
                }
            });
            overlay.addEventListener('click', (event) => {
                if (event.target === overlay) {
                    overlay.classList.remove('active');
                    passwordPanel.classList.remove('active');
                }
            });
            const closePanelBtn = document.getElementById('close-panel-btn');
            closePanelBtn.addEventListener('click', () => {
                overlay.classList.remove('active');
                passwordPanel.classList.remove('active');
            });
            const generateBtn = document.getElementById('generate-btn');
            const generatedPassword = document.getElementById('generated-password');
            generateBtn.addEventListener('click', () => {
                const length = parseInt(document.getElementById('length').value, 10);
                const includeUppercase = document.getElementById('include-uppercase').checked;
                const includeNumbers = document.getElementById('include-numbers').checked;
                const includeSymbols = document.getElementById('include-symbols').checked;
                const excludeCharacters = document.getElementById('exclude-characters').value;
            
                const generatedPassword = generatePassword(length, includeUppercase, includeNumbers, includeSymbols, excludeCharacters);
                input_add_password.value = generatedPassword;
            });
        }
    });

    // Confirm add password => envoie la requête pour ajouter le mot de passe
    async function addPassword() {
        const plateforme = document.querySelector('input[id="platform_name"]').value;
        const password = document.querySelector('input[id="password"]').value;
        const categoryId = document.querySelector('select[id="category_id"]').value;        
        const login = document.querySelector('input[id="login"]').value;
        const url = document.querySelector('input[id="url"]').value;
        const response = await fetch('/add_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                platform_name: plateforme,
                password: password,
                category_id: categoryId,
                login: login,
                url: url
            })
        });
        const data = await response.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert('Erreur lors de l\'ajout du mot de passe');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Share button
        document.querySelectorAll('.share-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const id = button.getAttribute('data-id');
                const response = await fetch(`/share_password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                const data = await response.json();
                if (data.success) {
                    alert('Mot de passe partagé avec succès');
                    alert(data.share_link);
                } else {
                    alert('Erreur lors du partage');
                }
            });
        });

        // Edit button
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const id = button.getAttribute('data-id');
                const newPassword = prompt('Entrez le nouveau mot de passe :');
                if (newPassword) {
                    const response = await fetch(`/edit`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: newPassword, id: id })
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Mot de passe modifié avec succès');
                        window.location.reload();
                    } else {
                        alert('Erreur lors de la modification');
                    }
                }
            });
        });

        // Delete button
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const id = button.getAttribute('data-id');
                if (confirm('Êtes-vous sûr de vouloir supprimer ce mot de passe ?')) {
                    const response = await fetch(`/delete`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: id })
                    });
                    const data = await response.json();
                    if (data.success) {
                        alert('Mot de passe supprimé avec succès');
                        window.location.reload();
                    } else {
                        alert('Erreur lors de la suppression');
                    }
                }
            });
        });
    });
    function generatePassword(length, includeUppercase, includeNumbers, includeSymbols, excludeCharacters) {
        const lowercase = 'abcdefghijklmnopqrstuvwxyz';
        const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const numbers = '0123456789';
        const symbols = '!@#$%^&*()_+[]{}|;:,.<>?';
    
        let characters = lowercase;
        if (includeUppercase) characters += uppercase;
        if (includeNumbers) characters += numbers;
        if (includeSymbols) characters += symbols;
    
        if (excludeCharacters) {
            const excludeSet = new Set(excludeCharacters);
            characters = [...characters].filter(char => !excludeSet.has(char)).join('');
        }
    
        let password = '';
        for (let i = 0; i < length; i++) {
            const randomIndex = Math.floor(Math.random() * characters.length);
            password += characters[randomIndex];
        }
        return password;
    }
</script>
{%endblock%}

{%block styles%}
<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th,
    td {
        border: 1px solid black;
        padding: 0.5rem;
    }

    tbody {
        display: block;
        max-height: 600px;
        overflow-y: auto;
    }

    thead,
    tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    .password-panel {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 20px;
        z-index: 1000;
        width: 300px;
    }

    .password-panel.active {
        display: block;
    }

    .password-panel h3 {
        margin-top: 0;
    }

    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
    }

    .overlay.active {
        display: block;
    }

    .btn {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
    }

    .btn:hover {
        background-color: #0056b3;
    }
</style>
{%endblock%}